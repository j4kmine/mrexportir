tinymce.PluginManager.add("quotesanalisis", function(a, b) {
    var state;

    /* Actions to do on button click */
    function Klik() {
        state = !state; /* Switching state */
        a.fire('quotesanalisis', {state: state});

        var text = a.selection.getContent({format:'raw'});
        var texttrim = text.replace(/&nbsp;/gi,'').replace(/<br>/gi,'');
        if (texttrim == "") {
            a.insertContent('<div class="quotes-analisis" style="background-image:url('+b+'/img/quotes.png)">&nbsp;</div><p>&nbsp;</p>');
        }else{
            var nodetext = a.selection.getNode();
            var textfix = nodetext.outerHTML;
            if (textfix.replace(/&nbsp;/gi,'').replace(/<br>/gi,'') == '<div class="quotes-analisis" style="background-image:url('+b+'/img/quotes.png)">' + texttrim + '</div>') {
               
                nodetext.remove();
                a.selection.setContent(texttrim);
            }else{
               a.selection.setContent('<div class="quotes-analisis" style="background-image:url('+b+'/img/quotes.png)">' + texttrim + '</div><p>&nbsp;</p>'); 
            }
        };
    }

    function toggleState_quotesanalisis() {
        var self = this;
        a.on('init', function(e) {
            self.active(e.state);
        });
    }

    /* Adding the button & command */
    a.addCommand('cmd_quotesanalisis', Klik);

    a.addButton("quotesanalisis", {
        text: "Quotes Analisis",
        icon: 1,
        // image: b + '/img/hlite.png',
        cmd: 'cmd_quotesanalisis',
        onPostRender: toggleState_quotesanalisis
    }), a.addMenuItem("quotesanalisis", {
        text: "Quotes Analisis",
        icon: 1,
        // image: b + '/img/hlite.png',
        context: "format",
        cmd: 'cmd_quotesanalisis',
        onPostRender: toggleState_quotesanalisis
    })
});