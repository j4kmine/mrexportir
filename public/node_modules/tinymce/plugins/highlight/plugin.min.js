tinymce.PluginManager.add("highlight", function(a, b) {
    var state;

    /* Actions to do on button click */
    function Klik() {
        state = !state; /* Switching state */
        a.fire('highlight', {state: state});

        var text = a.selection.getContent({format:'raw'});
        var texttrim = text.replace(/&nbsp;/gi,'').replace(/<br>/gi,'');
        if (texttrim == "") {
            a.insertContent('<span class="highlight">&nbsp;</span><p>&nbsp;</p>');
        }else{
            var nodetext = a.selection.getNode();
            var textfix = nodetext.outerHTML;
            if (textfix.replace(/&nbsp;/gi,'').replace(/<br>/gi,'') == '<span class="highlight">' + texttrim + '</span>') {
               
                nodetext.remove();
                a.selection.setContent(texttrim);
            }else{
               a.selection.setContent('<span class="highlight">' + texttrim + '</span><p>&nbsp;</p>'); 
            }
        };
    }

    function toggleState_highlight() {
        var self = this;
        a.on('init', function(e) {
            self.active(e.state);
        });
    }

    /* Adding the button & command */
    a.addCommand('cmd_highlight', Klik);

    a.addButton("highlight", {
        text: "",
        icon: 1,
        image: b + '/img/hlite.png',
        cmd: 'cmd_highlight',
        onPostRender: toggleState_highlight
    }), a.addMenuItem("highlight", {
        text: "Highlight",
        icon: 1,
        image: b + '/img/hlite.png',
        context: "format",
        cmd: 'cmd_highlight',
        onPostRender: toggleState_highlight
    })
});